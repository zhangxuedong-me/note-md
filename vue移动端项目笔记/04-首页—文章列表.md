# å››ã€é¦–é¡µâ€”æ–‡ç« åˆ—è¡¨

<img src="./assets/1566539328996.png" width="400">

## å‡†å¤‡

### åˆ›å»ºé¡µé¢ç»„ä»¶å¹¶é…ç½®è·¯ç”±

é€šè¿‡åˆ†æé¡µé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé¦–é¡µã€é—®ç­”ã€è§†é¢‘ã€æˆ‘çš„ éƒ½ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªåº•éƒ¨å¯¼èˆªæ ï¼Œæˆ‘ä»¬æ²¡å¿…è¦åœ¨æ¯ä¸ªé¡µé¢ä¸­éƒ½å†™ä¸€ä¸ªå¯¼èˆªæ ï¼Œä¸ºäº†é€šç”¨æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Vue Router çš„åµŒå¥—è·¯ç”±æ¥å¤„ç†ã€‚

- çˆ¶è·¯ç”±ï¼šä¸€ä¸ªç©ºé¡µé¢ï¼ŒåŒ…å«ä¸€ä¸ª tabbarï¼Œä¸­é—´ç•™å­è·¯ç”±å‡ºå£
- å­è·¯ç”±
  - é¦–é¡µ
  - é—®ç­”
  - è§†é¢‘
  - æˆ‘çš„
  - ã€‚ã€‚ã€‚

#### tabBar è§†å›¾ç»„ä»¶

![1570955885700](assets/1570955885700.png)

è¿™é‡Œä¸»è¦ä½¿ç”¨åˆ°çš„ Vant ç»„ä»¶ï¼š

- [Tabbar æ ‡ç­¾æ ](https://youzan.github.io/vant/#/zh-CN/tabbar)

1ã€åˆ›å»º `src/views/tabbar/index.vue`

```html
<template>
  <div>
    <!-- å­è·¯ç”±å‡ºå£ -->
    <router-view />
    <van-tabbar v-model="active">
      <van-tabbar-item icon="home-o">é¦–é¡µ</van-tabbar-item>
      <van-tabbar-item icon="search">é—®ç­”</van-tabbar-item>
      <van-tabbar-item icon="friends-o">è§†é¢‘</van-tabbar-item>
      <van-tabbar-item icon="setting-o">æˆ‘çš„</van-tabbar-item>
    </van-tabbar>
  </div>
</template>

<script>
  export default {
    name: "TabarPage",
    components: {},
    props: {},
    data() {
      return {
        active: 0
      };
    },
    computed: {},
    watch: {},
    created() {},
    methods: {}
  };
</script>

<style scoped></style>
```

2ã€ç„¶ååœ¨ `router/index.js` ä¸­é…ç½®è·¯ç”±è¡¨

```js
import Vue from 'vue'
import VueRouter from 'vue-router'
import Login from '@/views/login'
import Test from '@/views/test'
+ import Tabbar from '@/views/tabbar'

Vue.use(VueRouter)

// é…ç½®è·¯ç”±è¡¨
const routes = [
  {
    path: '/login',
    component: Login
  },
  {
    path: '/test',
    component: Test
  },
+  {
+    path: '/',
+    component: Tabbar
+  }
]

const router = new VueRouter({
  routes
})

export default router

```

è®¿é—® `/` è¿›è¡Œæµ‹è¯•ã€‚

#### é¦–é¡µè§†å›¾ç»„ä»¶

![1570953639217](assets/1570953639217.png)

1ã€åˆ›å»º `src/views/home/index.vue` ç»„ä»¶

```html
<template>
  <div>é¦–é¡µ</div>
</template>

<script>
  export default {
    name: "HomePage",
    components: {},
    props: {},
    data() {
      return {};
    },
    computed: {},
    watch: {},
    created() {},
    methods: {}
  };
</script>

<style scoped></style>
```

2ã€ç„¶ååœ¨ `router/index.js` ä¸­é…ç½®è·¯ç”±è¡¨

```js
import Vue from 'vue'
import VueRouter from 'vue-router'
import Login from '@/views/login'
import Test from '@/views/test'
import Tabbar from '@/views/tabbar'
+ import Home from '@/views/home'

Vue.use(VueRouter)

// é…ç½®è·¯ç”±è¡¨
const routes = [
  {
    path: '/login',
    component: Login
  },
  {
    path: '/test',
    component: Test
  },
  {
    path: '/',
    component: Tabbar,
+    children: [
+      {
+        path: '', // é»˜è®¤å­è·¯ç”±
+        component: Home
+      }
+    ]
  }
]

const router = new VueRouter({
  routes
})

export default router

```

æœ€åè®¿é—® `/` æµ‹è¯•ã€‚

### é¡µé¢ç»“æ„

è¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°çš„ç»„ä»¶ï¼š

- [NavBar å¯¼èˆªæ ](https://youzan.github.io/vant/#/zh-CN/nav-bar)
- [Tab æ ‡ç­¾é¡µ](https://youzan.github.io/vant/#/zh-CN/tab)
- [PullRefresh ä¸‹æ‹‰åˆ·æ–°](https://youzan.github.io/vant/#/zh-CN/pull-refresh)
- [List åˆ—è¡¨](https://youzan.github.io/vant/#/zh-CN/list)
  - è‡ªå¸¦ä¸Šæ‹‰åŠ è½½æ›´å¤šåŠŸèƒ½

![1570954667992](assets/1570954667992.png)

```html
<template>
  <div>
    <!-- å¯¼èˆªæ  -->
    <van-nav-bar title="é¦–é¡µ" />
    <!-- å¯¼èˆªæ  -->

    <!-- é¢‘é“åˆ—è¡¨ -->
    <van-tabs v-model="active">
      <van-tab title="æ ‡ç­¾ 1">
        <!--
          æ–‡ç« åˆ—è¡¨
          van-pull-refresh ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
          van-list åˆ—è¡¨ï¼Œå¸¦æœ‰ä¸Šæ‹‰åŠ è½½æ›´å¤šåŠŸèƒ½
        -->
        <van-pull-refresh v-model="isLoading" @refresh="onRefresh">
          <van-list
            v-model="loading"
            :finished="finished"
            finished-text="æ²¡æœ‰æ›´å¤šäº†"
            @load="onLoad"
          >
            <van-cell v-for="item in list" :key="item" :title="item" />
          </van-list>
        </van-pull-refresh>
        <!-- /æ–‡ç« åˆ—è¡¨ -->
      </van-tab>
      <van-tab title="æ ‡ç­¾ 2">å†…å®¹ 2</van-tab>
      <van-tab title="æ ‡ç­¾ 3">å†…å®¹ 3</van-tab>
      <van-tab title="æ ‡ç­¾ 4">å†…å®¹ 4</van-tab>
      <van-tab title="æ ‡ç­¾ 5">å†…å®¹ 5</van-tab>
      <van-tab title="æ ‡ç­¾ 6">å†…å®¹ 6</van-tab>
    </van-tabs>
    <!-- /é¢‘é“åˆ—è¡¨ -->
  </div>
</template>

<script>
  export default {
    name: "HomePage",
    components: {},
    props: {},
    data() {
      return {
        active: 0,
        list: [],
        loading: false,
        finished: false,
        isLoading: false
      };
    },
    computed: {},
    watch: {},
    created() {},
    methods: {
      onLoad() {
        // å¼‚æ­¥æ›´æ–°æ•°æ®
        setTimeout(() => {
          for (let i = 0; i < 10; i++) {
            this.list.push(this.list.length + 1);
          }
          // åŠ è½½çŠ¶æ€ç»“æŸ
          this.loading = false;

          // æ•°æ®å…¨éƒ¨åŠ è½½å®Œæˆ
          if (this.list.length >= 40) {
            this.finished = true;
          }
        }, 500);
      },

      onRefresh() {
        setTimeout(() => {
          this.$toast("åˆ·æ–°æˆåŠŸ");
          this.isLoading = false;
        }, 2000);
      }
    }
  };
</script>

<style scoped></style>
```

### æ ·å¼è°ƒæ•´

æˆ‘ä»¬çš„éœ€æ±‚ï¼š

- å¤´éƒ¨å›ºå®šå®šä½
- é¢‘é“åˆ—è¡¨å›ºå®šå®šä½

1ã€è®©å¤´éƒ¨å¯¼èˆªæ å›ºå®šå®šä½

```html
<van-nav-bar title="é¦–é¡µ" fixed />
```

2ã€è®©é¢‘é“åˆ—è¡¨å›ºå®šå®šä½

```css
<style lang="less" scoped>
.home {
  .article-info span {
    margin-right: 10px;
  }
  .van-tabs {
    // é¢‘é“åˆ—è¡¨
    /deep/ .van-tabs__wrap {
      position: fixed;
      top: 46px;
      z-index: 2;
      right: 0;
      left: 0;
    }
    // é¢‘é“å†…å®¹
    /deep/ .van-tabs__content {
      margin-top: 90px;
    }
  }
}
</style>
```

å¦‚æœæƒ³è¦åœ¨çˆ¶ç»„ä»¶ä¸­å½±å“å­ç»„ä»¶æ ·å¼ï¼š

- è¦å˜›ä¸è¦æœ‰ä½œç”¨åŸŸï¼Œé‚£å°±æ˜¯å…¨å±€ï¼Œå½±å“ä»»ä½•ç»„ä»¶

- å¦‚æœæœ‰ä½œç”¨åŸŸ
  - é»˜è®¤åªèƒ½å½±å“åˆ°è‡ªå­ç»„ä»¶çš„æ ¹èŠ‚ç‚¹
    - å®¡æŸ¥å…ƒç´ æ‰¾åˆ°å­ç»„ä»¶æ ¹èŠ‚ç‚¹ç±»åä½¿ç”¨
    - æˆ–è€…æ‰‹åŠ¨ç»™å­ç»„ä»¶æ·»åŠ ä¸€ä¸ª classï¼Œå®ƒä¼šè‡ªåŠ¨æ·»åŠ åˆ°å­ç»„ä»¶æ ¹èŠ‚ç‚¹çš„ class ä¸­
  - å¦‚æœéœ€è¦å½±å“çš„æ›´æ·±ï¼Œåˆ™ä½¿ç”¨æ·±åº¦é€‰æ‹©å™¨ï¼š`>>>`ã€`/deep/`ã€`::v-deep`
    - `>>>` åœ¨ lessã€sassã€stylus ç­‰ CSS é¢„å¤„ç†å™¨ä¸­ä¼šæŠ¥é”™
    - æ‰€ä»¥å»ºè®®ä½¿ç”¨ `/deep/` æˆ–è€… `::v-deep`

> è¯¦è§ï¼šã€Šè¡¥å……-å…³äºç»„ä»¶çš„ä½œç”¨åŸŸæ ·å¼ã€‹

## å±•ç¤ºé¢‘é“åˆ—è¡¨

![1570955606232](assets/1570955606232.png)

æ€è·¯ï¼š

- å°è£…è¯·æ±‚æ–¹æ³•
- åŠ è½½è°ƒç”¨è·å–æ•°æ®
- æ¨¡æ¿ç»‘å®š

1ã€åœ¨ `src/api/user.js` ä¸­æ–°å¢ä¸€ä¸ªè¯·æ±‚æ–¹æ³•

```js
/**
 * è·å–ç”¨æˆ·é¢‘é“åˆ—è¡¨
 * å¦‚æœç™»å½•äº†ï¼šè·å–ç”¨æˆ·é¢‘é“åˆ—è¡¨
 * æ²¡æœ‰ç™»å½•ï¼šè·å–é»˜è®¤æ¨èçš„é¢‘é“åˆ—è¡¨
 */
export function getUserChannels() {
  return request({
    method: "GET",
    url: "/app/v1_0/user/channels"
  });
}
```

2ã€åœ¨é¦–é¡µä¸­è¯·æ±‚è·å–æ•°æ®

```js
+ import { getUserChannels } from '@/api/user'

export default {
  name: 'HomePage',
  components: {},
  props: {},
  data () {
    return {
      active: 0,
      list: [],
      loading: false,
      finished: false,
      isLoading: false,
+      channels: [] // é¢‘é“åˆ—è¡¨
    }
  },
  computed: {},
  watch: {
  },
  created () {
+    this.loadUserChannels()
  },
  methods: {
    onLoad () {
      // å¼‚æ­¥æ›´æ–°æ•°æ®
      setTimeout(() => {
        for (let i = 0; i < 10; i++) {
          this.list.push(this.list.length + 1)
        }
        // åŠ è½½çŠ¶æ€ç»“æŸ
        this.loading = false

        // æ•°æ®å…¨éƒ¨åŠ è½½å®Œæˆ
        if (this.list.length >= 40) {
          this.finished = true
        }
      }, 500)
    },

    onRefresh () {
      setTimeout(() => {
        this.$toast('åˆ·æ–°æˆåŠŸ')
        this.isLoading = false
      }, 2000)
    },

+    async loadUserChannels () {
+      const res = await getUserChannels()
+      this.channels = res.data.data.channels
+    }
  }
}
```

> æç¤ºï¼šä»£ç å†™å®Œä»¥ååœ¨æµè§ˆå™¨çš„è°ƒè¯•å·¥å…·ä¸­æŸ¥çœ‹æ˜¯å¦èƒ½å¤ŸåŠ è½½è·å–åˆ° channels æ•°æ®ï¼Œç¡®ä¿èƒ½æ­£å¸¸è·å–åˆ°æ•°æ®ä»¥åï¼Œå†è¿›è¡Œæ¨¡æ¿ç»‘å®šã€‚

3ã€æ‹¿åˆ°æ•°æ®ï¼Œæ¸²æŸ“æ¨¡æ¿

```html
<!-- é¢‘é“åˆ—è¡¨ -->
<van-tabs v-model="active">
  <van-tab
    +
    :title="channel.name"
    +
    v-for="channel in channels"
    +
    :key="channel.id"
  >
    ...
  </van-tab>
</van-tabs>
<!-- /é¢‘é“åˆ—è¡¨ -->
```

## å±•ç¤ºæ–‡ç« åˆ—è¡¨

### åˆ†æåˆ—è¡¨ç»„ä»¶çš„ä½¿ç”¨

List çš„è¿è¡Œæœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ

```
List ä¼šç›‘å¬æµè§ˆå™¨çš„æ»šåŠ¨äº‹ä»¶å¹¶è®¡ç®—åˆ—è¡¨çš„ä½ç½®ï¼Œå½“åˆ—è¡¨åº•éƒ¨ä¸å¯è§†åŒºåŸŸçš„è·ç¦»å°äºoffsetæ—¶ï¼ŒList ä¼šè§¦å‘ä¸€æ¬¡ load äº‹ä»¶ã€‚
```

ä¸ºä»€ä¹ˆ List åˆå§‹åŒ–åä¼šç«‹å³è§¦å‘ load äº‹ä»¶ï¼Ÿ

```
List åˆå§‹åŒ–åä¼šè§¦å‘ä¸€æ¬¡ load äº‹ä»¶ï¼Œç”¨äºåŠ è½½ç¬¬ä¸€å±çš„æ•°æ®ï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥é€šè¿‡`immediate-check`å±æ€§å…³é—­ã€‚
```

ä¸ºä»€ä¹ˆä¼šè¿ç»­è§¦å‘ load äº‹ä»¶ï¼Ÿ

```
å¦‚æœä¸€æ¬¡è¯·æ±‚åŠ è½½çš„æ•°æ®æ¡æ•°è¾ƒå°‘ï¼Œå¯¼è‡´åˆ—è¡¨å†…å®¹æ— æ³•é“ºæ»¡å½“å‰å±å¹•ï¼ŒList ä¼šç»§ç»­è§¦å‘ load äº‹ä»¶ï¼Œç›´åˆ°å†…å®¹é“ºæ»¡å±å¹•æˆ–æ•°æ®å…¨éƒ¨åŠ è½½å®Œæˆã€‚å› æ­¤ä½ éœ€è¦è°ƒæ•´æ¯æ¬¡è·å–çš„æ•°æ®æ¡æ•°ï¼Œç†æƒ³æƒ…å†µä¸‹æ¯æ¬¡è¯·æ±‚è·å–çš„æ•°æ®æ¡æ•°åº”èƒ½å¤Ÿå¡«æ»¡ä¸€å±é«˜åº¦ã€‚
```

loading å’Œ finished åˆ†åˆ«æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿ

> `List`æœ‰ä»¥ä¸‹ä¸‰ç§çŠ¶æ€ï¼Œç†è§£è¿™äº›çŠ¶æ€æœ‰åŠ©äºä½ æ­£ç¡®åœ°ä½¿ç”¨`List`ç»„ä»¶ï¼š
>
> - éåŠ è½½ä¸­ï¼Œ`loading`ä¸º`false`ï¼Œæ­¤æ—¶ä¼šæ ¹æ®åˆ—è¡¨æ»šåŠ¨ä½ç½®åˆ¤æ–­æ˜¯å¦è§¦å‘`load`äº‹ä»¶ï¼ˆåˆ—è¡¨å†…å®¹ä¸è¶³ä¸€å±å¹•æ—¶ï¼Œä¼šç›´æ¥è§¦å‘ï¼‰
> - åŠ è½½ä¸­ï¼Œ`loading`ä¸º`true`ï¼Œè¡¨ç¤ºæ­£åœ¨å‘é€å¼‚æ­¥è¯·æ±‚ï¼Œæ­¤æ—¶ä¸ä¼šè§¦å‘`load`äº‹ä»¶
> - åŠ è½½å®Œæˆï¼Œ`finished`ä¸º`true`ï¼Œæ­¤æ—¶ä¸ä¼šè§¦å‘`load`äº‹ä»¶
>
> åœ¨æ¯æ¬¡è¯·æ±‚å®Œæ¯•åï¼Œéœ€è¦æ‰‹åŠ¨å°†`loading`è®¾ç½®ä¸º`false`ï¼Œè¡¨ç¤ºæœ¬æ¬¡ load åŠ è½½ç»“æŸ

ä½¿ç”¨ float å¸ƒå±€åä¸€ç›´è§¦å‘åŠ è½½ï¼Ÿ

```
è‹¥ List çš„å†…å®¹ä½¿ç”¨äº† float å¸ƒå±€ï¼Œå¯ä»¥åœ¨å®¹å™¨ä¸Šæ·»åŠ van-clearfixç±»åæ¥æ¸…é™¤æµ®åŠ¨ï¼Œä½¿å¾— List èƒ½æ­£ç¡®åˆ¤æ–­å…ƒç´ ä½ç½®
```

### ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

![å±•ç¤ºæ–‡ç« åˆ—è¡¨-ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®](assets/å±•ç¤ºæ–‡ç« åˆ—è¡¨-ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®.gif)

é¢‘é“æ˜¯éå†å‡ºæ¥çš„ï¼Œé¢‘é“ä¸­çš„æ–‡ç« åˆ—è¡¨å½“ç„¶ä¹Ÿæ˜¯éå†å‡ºæ¥çš„ã€‚æ‰€ä»¥è¦ææ¸…æ¥šçš„å‡ ç‚¹æ˜¯ï¼š

- æ¯ä¸ªé¢‘é“éƒ½æœ‰ä¸€ä¸ªæ–‡ç« åˆ—è¡¨ç»„ä»¶ï¼ˆéå†å‡ºæ¥çš„ï¼‰
- ä¸åŒçš„é¢‘é“åº”è¯¥æ‹¥æœ‰ä¸åŒçš„æ•°æ®çŠ¶æ€
  - é¢‘é“çš„æ–‡ç« åˆ—è¡¨
  - é¢‘é“æ˜¯å¦åŠ è½½ç»“æŸ

```
æ¯ä¸ªé¢‘é“éƒ½æœ‰ä¸€ä»½å„¿è‡ªå·±çš„æ–‡ç« åˆ—è¡¨æ•°æ®ï¼š

[
  {
    id: xx, é¢‘é“id
    name: 'xxxx', é¢‘é“åå­—
    list: [] æ–‡ç« åˆ—è¡¨
  },
  {
    id: xx, é¢‘é“id
    name: 'xxxx', é¢‘é“åå­—
    list: [] æ–‡ç« åˆ—è¡¨
  },
]

æŸ¥çœ‹é¢‘é“aï¼š
  - è¯·æ±‚è·å–é¢‘é“a çš„æ–‡ç« åˆ—è¡¨
  - å°†æ•°æ®æ·»åŠ åˆ° é¢‘é“a.æ–‡ç« åˆ—è¡¨ä¸­

æŸ¥çœ‹é¢‘é“b:
  - è¯·æ±‚è·å–é¢‘é“b çš„æ–‡ç« åˆ—è¡¨
  - å°†æ•°æ®æ·»åŠ åˆ° é¢‘é“b.æ–‡ç« åˆ—è¡¨ä¸­
```

1ã€æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦å°†æ•°æ®è¿›è¡Œæ”¹é€ ï¼Œä¸ºæ¯ä¸ªé¢‘é“æ·»åŠ è‡ªå®šä¹‰æ•°æ®ï¼šæ–‡ç« åˆ—è¡¨ã€finished ç»“æŸçŠ¶æ€

```js
async loadUserChannels () {
  const res = await getUserChannels()
  const channels = res.data.data.channels
+  channels.forEach(channel => {
+    channel.articles = [] // é¢‘é“çš„æ–‡ç« åˆ—è¡¨
+    channel.finished = false // é¢‘é“çš„åŠ è½½ç»“æŸçŠ¶æ€
+  })
  this.channels = channels
}
```

2ã€ç„¶ååœ¨è®©æ–‡ç« åˆ—è¡¨ç»‘å®šæ¯ä¸ªé¢‘é“å¯¹åº”çš„æ•°æ®

```html
<!-- é¢‘é“åˆ—è¡¨ -->
<van-tabs v-model="active">
  <van-tab :title="channel.name" v-for="channel in channels" :key="channel.id">
    <van-pull-refresh v-model="isLoading" @refresh="onRefresh">
      <van-list
        v-model="loading"
        +
        :finished="channel.finished"
        finished-text="æ²¡æœ‰æ›´å¤šäº†"
        @load="onLoad"
      >
        <p>{{ channel.name }}</p>
        <van-cell
          +
          v-for="item in channel.articles"
          :key="item"
          :title="item"
        />
      </van-list>
    </van-pull-refresh>
    <!-- /æ–‡ç« åˆ—è¡¨ -->
  </van-tab>
</van-tabs>
<!-- /é¢‘é“åˆ—è¡¨ -->
```

3ã€æœ€åå°† `onLoad` å‡½æ•°ä¿®æ”¹ä¸º

```js
onLoad () {
  // è·å–å½“å‰é¢‘é“
  // this.active åŒå‘ç»‘å®šäº†æ ‡ç­¾é¡µç»„ä»¶ï¼Œè¯¥æ•°æ®æ­£å¥½å¯¹åº”é¢‘é“çš„ç´¢å¼•
  const activeChannel = this.channels[this.active]

  // è·å–å½“å‰é¢‘é“çš„æ–‡ç« åˆ—è¡¨
  const articles = activeChannel.articles

  // 1. è¯·æ±‚åŠ è½½æ•°æ®
  setTimeout(() => {
    // 2. å°†æ•°æ®æ·»åŠ åˆ°å½“å‰é¢‘é“çš„æ–‡ç« åˆ—è¡¨ä¸­
    for (let i = 0; i < 10; i++) {
      articles.push(articles.length + 1)
    }

    // 3. å°† loading è®¾ç½®ä¸º false
    // åŠ è½½çŠ¶æ€ç»“æŸ
    // å…³é—­æœ¬æ¬¡çš„ loading çŠ¶æ€ï¼Œå®ƒä¼šåˆ¤å®šå½“å‰æ•°æ®æ˜¯å¦å¤Ÿä¸€å±ï¼Œä¸å¤Ÿå°±ç»§ç»­è‡ªåŠ¨ onLoad
    this.loading = false

    // 4. åˆ¤æ–­å¦‚æœæ²¡æœ‰æ•°æ®äº†ï¼Œå°†å½“å‰é¢‘é“çš„ç»“æŸçŠ¶æ€ finished è®¾ç½®ä¸º true
    if (articles.length >= 40) {
      // å¦‚æœåé¢æ²¡æœ‰æ•°æ®äº†ï¼Œå°† finished è®¾ç½®ä¸º trueï¼Œä¹‹åä¸å†è§¦å‘ onLoad
      activeChannel.finished = true
    }
  }, 1000)
},
```

æœ€åæµ‹è¯•ç»“æœã€‚

### ä½¿ç”¨çœŸå®æ•°æ®

![å±•ç¤ºæ–‡ç« åˆ—è¡¨-ä½¿ç”¨çœŸå®æ•°æ®](assets/å±•ç¤ºæ–‡ç« åˆ—è¡¨-ä½¿ç”¨çœŸå®æ•°æ®.gif)

å®ç°æ€è·¯ï¼š

- å°è£…è·æ•°æ®æ¥å£
- è¯·æ±‚åŠ è½½æ›´å¤š
- æ¨¡æ¿ç»‘å®š

1ã€åˆ›å»º `src/api/article.js`

```js
/**
 * æ–‡ç« ç›¸å…³çš„æ•°æ®æ¥å£
 */
import request from "@/utils/request";

/**
 * è·å–æ–‡ç« åˆ—è¡¨
 */
export function getArticles(params) {
  return request({
    method: "GET",
    url: "/app/v1_1/articles",
    params
  });
}
```

> æ³¨æ„ï¼šä½¿ç”¨æ¥å£æ–‡æ¡£ä¸­æœ€ä¸‹é¢çš„ **é¢‘é“æ–°é—»æ¨è\_V1.1**

2ã€ç„¶ååœ¨é¦–é¡µä¸­åˆ—è¡¨ç»„ä»¶ `onload` çš„æ—¶å€™è¯·æ±‚åŠ è½½æ–‡ç« åˆ—è¡¨

```js
import { getUserChannels } from '@/api/user'
+ import { getArticles } from '@/api/article'

export default {
  name: 'HomePage',
  components: {},
  props: {},
  data () {
    return {
      active: 0,
      list: [],
      loading: false,
      finished: false,
      isLoading: false,
      channels: [] // é¢‘é“åˆ—è¡¨
    }
  },
  computed: {},
  watch: {
  },
  created () {
    this.loadUserChannels()
  },
  methods: {
    async onLoad () {
      // å½“å‰é¢‘é“
      const activeChannel = this.channels[this.active]

      // å½“å‰é¢‘é“çš„çš„æ–‡ç« åˆ—è¡¨
      const articles = activeChannel.articles

      // 1. è¯·æ±‚è·å–æ•°æ®
+      const res = await getArticles({
+        channel_id: activeChannel.id, // é¢‘é“ id
+        timestamp: activeChannel.timestamp || Date.now(), // è·å–ä¸‹ä¸€é¡µæ•°æ®çš„æ—¶é—´æˆ³ï¼ŒDate.now() è¡¨ç¤ºè·å–å½“å‰æœ€æ–°æ•°æ®
+        with_top: 1
+      })

      // 2. å°†æ•°æ®æ·»åŠ åˆ°å½“å‰é¢‘é“çš„æ–‡ç« åˆ—è¡¨ä¸­
      // ...æ•°ç»„ï¼Œæ•°ç»„çš„å±•å¼€æ“ä½œç¬¦ï¼Œå®ƒä¼šæŠŠæ•°ç»„å…ƒç´ ä¸€ä¸ªä¸€ä¸ªçš„æ‹¿å‡ºæ¥ï¼Œä¼ é€’ç»™ä½¿ç”¨çš„ä½ç½®
+      articles.push(...res.data.data.results)

      // 3. å°† loading è®¾ç½®ä¸º false
      this.loading = false

      // 4. åˆ¤æ–­è¿˜æœ‰ä¸‹ä¸€é¡µæ•°æ®ï¼Œåˆ™æ›´æ–°è·å–ä¸‹ä¸€ä¸ªæ•°æ®çš„æ—¶é—´æˆ³
      //    å¦‚æœæ²¡æœ‰äº†ï¼Œåˆ™å°† finished è®¾ç½®ä¸º trueï¼Œä¸å†åŠ è½½æ›´å¤šäº†
 +     const preTimestamp = res.data.data.pre_timestamp
 +     if (preTimestamp) {
 +       // æ›´æ–°è·å–ä¸‹ä¸€é¡µæ•°æ®çš„æ—¶é—´æˆ³
 +       activeChannel.timestamp = preTimestamp
 +     } else {
 +       activeChannel.finished = true
 +     }
    },

    onRefresh () {
      setTimeout(() => {
        this.$toast('åˆ·æ–°æˆåŠŸ')
        this.isLoading = false
      }, 2000)
    },

    async loadUserChannels () {
      const res = await getUserChannels()
      const channels = res.data.data.channels
      channels.forEach(channel => {
        channel.articles = [] // é¢‘é“çš„æ–‡ç« åˆ—è¡¨
        channel.finished = false // é¢‘é“çš„åŠ è½½ç»“æŸçŠ¶æ€
+        channel.timestamp = null // ç”¨äºè·å–é¢‘é“ä¸‹ä¸€é¡µæ•°æ®çš„æ—¶é—´æˆ³
      })
      this.channels = channels
    }
  }
}
```

3ã€å°†æ•°æ®ç»‘å®šåˆ°æ¨¡æ¿ä¸­å±•ç¤º

```html
<!-- é¢‘é“åˆ—è¡¨ -->
<van-tabs v-model="active">
  <van-tab :title="channel.name" v-for="channel in channels" :key="channel.id">
    <van-pull-refresh v-model="isLoading" @refresh="onRefresh">
      <van-list
        v-model="loading"
        :finished="channel.finished"
        finished-text="æ²¡æœ‰æ›´å¤šäº†"
        @load="onLoad"
      >
        <van-cell
          +
          v-for="article in channel.articles"
          +
          :key="article.art_id.toString()"
          +
          :title="article.title"
        />
      </van-list>
    </van-pull-refresh>
    <!-- /æ–‡ç« åˆ—è¡¨ -->
  </van-tab>
</van-tabs>
<!-- /é¢‘é“åˆ—è¡¨ -->
```

æœ€ç»ˆå®Œæˆï¼Œæµ‹è¯•ç»“æœã€‚

### ä¸‹æ‹‰åˆ·æ–°

![å±•ç¤ºæ–‡ç« åˆ—è¡¨-ä¸‹æ‹‰åˆ·æ–°](assets/å±•ç¤ºæ–‡ç« åˆ—è¡¨-ä¸‹æ‹‰åˆ·æ–°.gif)

æ€è·¯ï¼š

- æ³¨å†Œä¸‹æ‹‰åˆ·æ–°äº‹ä»¶ï¼ˆç»„ä»¶ï¼‰çš„å¤„ç†å‡½æ•°
- å‘é€è¯·æ±‚è·å–æ–‡ç« åˆ—è¡¨æ•°æ®
- æŠŠè·å–åˆ°çš„æ•°æ®æ·»åŠ åˆ°å½“å‰é¢‘é“çš„æ–‡ç« åˆ—è¡¨çš„é¡¶éƒ¨
- æç¤ºç”¨æˆ·åˆ·æ–°æˆåŠŸï¼

ä¸‹æ‹‰åˆ·æ–°æ—¶ä¼šè§¦å‘ç»„ä»¶çš„ `refresh` äº‹ä»¶ï¼Œåœ¨äº‹ä»¶çš„å›è°ƒå‡½æ•°ä¸­å¯ä»¥è¿›è¡ŒåŒæ­¥æˆ–å¼‚æ­¥æ“ä½œï¼Œæ“ä½œå®Œæˆåå°† `v-model` è®¾ç½®ä¸º `false`ï¼Œè¡¨ç¤ºåŠ è½½å®Œæˆã€‚

```js
async onRefresh () {
  const activeChannel = this.channels[this.active]

  // 1. è¯·æ±‚è·å–æœ€æ–°æ•°æ®
  const res = await getArticles({
    channel_id: activeChannel.id,
    timestamp: Date.now(), // è·å–æœ€æ–°æ•°æ®ä¼ é€’å½“å‰æœ€æ–°æ—¶é—´æˆ³å³å¯
    with_top: 1
  })

  // 2. æŠŠæ•°æ®æ”¾åˆ°åˆ—è¡¨çš„é¡¶éƒ¨
  const articles = res.data.data.results
  activeChannel.articles.unshift(...articles)

  // 3. åœæ­¢ä¸‹æ‹‰åˆ·æ–°çš„è½¬åœˆåœˆ
  this.isLoading = false

  // 4. æç¤ºç”¨æˆ·åˆ·æ–°æˆåŠŸ
  const message = articles.length
    ? `æ›´æ–°äº†${articles.length}æ¡æ•°æ®`
    : 'æš‚æ— æ•°æ®æ›´æ–°'
  this.$toast(message)
},
```

### å±•ç¤ºè¯¦ç»†çš„åˆ—è¡¨é¡¹ä¿¡æ¯

![1571023059205](assets/1571023059205.png)

è¿™é‡Œä¸»è¦ä½¿ç”¨åˆ°çš„ Vant ç»„ä»¶ï¼š

- [Grid å®«æ ¼](https://youzan.github.io/vant/#/zh-CN/grid)
- [Image å›¾ç‰‡](https://youzan.github.io/vant/#/zh-CN/image)

åœ¨æ¨¡æ¿ä¸­æ–°å¢ï¼š

```html
<van-cell
  v-for="(article, index) in channel.articles"
  :key="index"
  :title="article.title"
>
  +
  <div slot="label">
    +
    <van-grid :border="false" :column-num="3">
      +
      <van-grid-item v-for="(img, index) in article.cover.images" :key="index">
        + <van-image height="80" :src="img" /> +
      </van-grid-item>
      +
    </van-grid>
    +
    <div class="article-info">
      + <span>{{ article.aut_name }}</span> +
      <span>{{ article.comm_count }}è¯„è®º</span> +
      <span>{{ article.pubdate }}</span> +
    </div>
    +
  </div>
</van-cell>
```

ç„¶ååœ¨ style ä¸­è®¾ç½®ä¸€ä¸‹æ ·å¼ï¼š

```css
.home {
  .article-info span {
    margin-right: 10px;
  }
}
```

### å›¾ç‰‡æ‡’åŠ è½½

æ­£å¸¸æƒ…å†µä¸‹ï¼Œåªè¦ img æ ‡ç­¾è¿›å…¥äº† DOM ä¸­å°±ä¼šæŠŠè¯·æ±‚å‘å‡ºå»ã€‚

å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªé•¿é•¿çš„åˆ—è¡¨ï¼Œåé¢çš„å†…å®¹å¯èƒ½è¿˜æ²¡æœ‰å»çœ‹å‘¢ï¼Œè€Œå›¾ç‰‡å·²ç»è¯·æ±‚åŠ è½½äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å¯¹è¿™ç§æƒ…å†µåšä¸€äº›ä¼˜åŒ–ï¼Œæ‡’åŠ è½½ï¼šå½“å†…å®¹æ»šåŠ¨åˆ°å¯è§†åŒºåŸŸæˆ–è€…å³å°†åˆ°è¾¾å¯è§†åŒºåŸŸçš„æ—¶å€™ï¼ŒåŠ è½½å›¾ç‰‡ã€‚

Vant æä¾›äº†[Lazyload](https://youzan.github.io/vant/#/zh-CN/lazyload)ç»„ä»¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°å›¾ç‰‡æ‡’åŠ è½½çš„åŠŸèƒ½ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†æ–‡ç« åˆ—è¡¨ä¸­çš„æ–‡ç« å›¾ç‰‡é…ç½®ä¸ºå›¾ç‰‡æ‡’åŠ è½½çš„æ–¹å¼ï¼Œå¢å¼ºç”¨æˆ·ä½“éªŒã€‚

1ã€æ³¨å†Œç»„ä»¶

```js
import Vue from "vue";
import { Lazyload } from "vant";

// options ä¸ºå¯é€‰å‚æ•°ï¼Œæ— åˆ™ä¸ä¼ 
Vue.use(Lazyload, options);
```

2ã€ä½¿ç”¨

å¦‚æœæ˜¯åŸç”Ÿçš„ img æ ‡ç­¾ï¼Œåˆ™å°†åŸæ¥çš„ `src` é…ç½®ä¸º `v-lazy` å³å¯ï¼š

```html
<img v-for="img in imageList" v-lazy="å›¾ç‰‡åœ°å€" />
```

å¦‚æœä½¿ç”¨çš„æ˜¯ Vant æä¾›çš„å›¾ç‰‡ç»„ä»¶ï¼Œåˆ™ç›´æ¥é…ç½® `lazy-load` å±æ€§å³å¯ï¼š

```html
<van-image
  width="100"
  height="100"
  lazy-load
  src="https://img.yzcdn.cn/vant/cat.jpeg"
/>
```

> æ³¨æ„ï¼šå¦‚æœæµè§ˆå™¨æ§åˆ¶å°å¼€å¯äº† `Disable cache` åŠŸèƒ½ï¼Œåˆ™ä¼šçœ‹åˆ°æ¯ä¸ªå›¾ç‰‡å‡ºç°ä¸¤æ¬¡è¯·æ±‚ï¼Œè¯¥é—®é¢˜å¹¶ä¸å½±å“æœ€ç»ˆç»“æœã€‚

### ç›¸å¯¹æ—¶é—´å¤„ç†

Day.js æ˜¯ä¸€ä¸ªè½»é‡çš„å¤„ç†æ—¶é—´å’Œæ—¥æœŸçš„ JavaScript åº“ï¼Œå’Œ Moment.js çš„ API è®¾è®¡ä¿æŒå®Œå…¨ä¸€æ ·. å¦‚æœæ‚¨æ›¾ç»ç”¨è¿‡ Moment.js, é‚£ä¹ˆæ‚¨å·²ç»çŸ¥é“å¦‚ä½•ä½¿ç”¨ Day.jsã€‚

- ğŸ•’ å’Œ Moment.js ç›¸åŒçš„ API å’Œç”¨æ³•
- ğŸ’ª ä¸å¯å˜æ•°æ® (Immutable)
- ğŸ”¥ æ”¯æŒé“¾å¼æ“ä½œ (Chainable)
- ğŸŒ å›½é™…åŒ– I18n
- ğŸ“¦ ä»… 2kb å¤§å°çš„å¾®å‹åº“
- ğŸ‘« å…¨æµè§ˆå™¨å…¼å®¹

1ã€å®‰è£…ä¾èµ–

```sh
# yarn add dayjs
npm i dayjs
```

2ã€åˆ›å»º `src/utils/dayjs.js`

```js
/**
 * å°è£…è‡ªå®šä¹‰ dayjs æ—¥æœŸå¤„ç†æ¨¡å—
 */
import Vue from "vue";
import dayjs from "dayjs";

import "dayjs/locale/zh-cn"; // æŒ‰éœ€åŠ è½½
import relativeTime from "dayjs/plugin/relativeTime";

dayjs.locale("zh-cn"); // å…¨å±€ä½¿ç”¨è¥¿ç­ç‰™è¯­

// dayjs æœ¬èº«åªå¤„ç†æ—¥æœŸæ ¼å¼åŒ–ä¹‹ç±»çš„æ ¸å¿ƒåŠŸèƒ½
// å…¶å®ƒä¾‹å¦‚ç›¸å¯¹æ—¶é—´ï¼Œéœ€è¦å•ç‹¬é…ç½®å®ƒè‡ªå·±çš„æ’ä»¶æ‰å¯ä»¥ä½¿ç”¨
dayjs.extend(relativeTime);

// æ‰©å±•ä¸€ä¸ªå…¨å±€è¿‡æ»¤å™¨ï¼šè®¡ç®—ç›¸å¯¹æ—¶é—´
Vue.filter("relativeTime", value => {
  // dayjs() è·å–å½“å‰æœ€æ–°æ—¶é—´
  // dayjs(æ—¶é—´) å®ƒä¼šæŠŠä½ ç»™å®šçš„æ—¶é—´è½¬ä¸ºè‡ªå·±çš„æ—¶é—´ç±»å‹
  //   2019-12-3 10:19:37
  //   156156156165
  //   2019
  //   2019-12-3
  return dayjs().from(dayjs(value));
});
```

> å¦‚æœä½ å¿˜äº†è¿‡æ»¤å™¨çš„ä½¿ç”¨ï¼Œ è¯·æŸ¥é˜… PC ç«¯é¡¹ç›®ä¸­çš„æ–‡ç« åˆ—è¡¨ä¸­çš„æ–‡ç« çš„å‘å¸ƒæ—¶é—´å¤„ç†ã€‚

3ã€åœ¨ `src/main.js` ä¸­åŠ è½½æ‰§è¡Œ

```js
...
import './utils/dayjs'
```

4ã€ç„¶ååœ¨æ¨¡æ¿ä¸­ä½¿ç”¨

```html
...
<!--
	è¿‡æ»¤å™¨çš„æœ¬è´¨ä½œç”¨ï¼šå°±æ˜¯ä¸ºæ¨¡æ¿æä¾›ä¸€ä¸ªå‡½æ•°è¿›è¡Œè°ƒç”¨
	è¿‡æ»¤å™¨æ˜¯å‡½æ•°ï¼Œä½¿ç”¨è¿‡æ»¤å™¨å°±æ˜¯åœ¨è°ƒç”¨å‡½æ•°
	| å‰é¢çš„ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿‡æ»¤å™¨å‡½æ•°
	è¿‡æ»¤å™¨å‡½æ•°çš„è¿”å›å€¼å°†æ¸²æŸ“åˆ°è¿™é‡Œ
-->
<span>{{ article.pubdate | relativeTime }}</span>
```

æœ€ååœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ç»“æœã€‚
